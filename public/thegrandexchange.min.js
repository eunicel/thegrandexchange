/*! thegrandexchange 02-12-2014 */
angular.module("thegrandexchange",["ui.router","ngCookies","ngTable"],function(a){a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",a.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var b=function(a){var c,d,e,f,g,h,i,j="";for(c in a)if(d=a[c],d instanceof Array)for(i=0;i<d.length;++i)g=d[i],e=c+"["+i+"]",h={},h[e]=g,j+=b(h)+"&";else if(d instanceof Object)for(f in d)g=d[f],e=c+"["+f+"]",h={},h[e]=g,j+=b(h)+"&";else void 0!==d&&null!==d&&(j+=encodeURIComponent(c)+"="+encodeURIComponent(d)+"&");return j.length?j.substr(0,j.length-1):j};a.defaults.transformRequest=[function(a){return angular.isObject(a)&&"[object File]"!==String(a)?b(a):a}]}).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("login",{url:"/login",templateUrl:"/views/login.html",controller:"LoginCtrl"}).state("newUser",{url:"/newUser",templateUrl:"/views/newUser.html",controller:"NewUsersCtrl"}).state("marketplace",{url:"/marketplace",templateUrl:"/views/marketplace.html",controller:"MainCtrl"}).state("offers",{url:"/offers",templateUrl:"/views/offers.html",controller:"OffersCtrl"}).state("completed",{url:"/completed",templateUrl:"/views/completed.html",controller:"CompletedCtrl"}).state("profile",{url:"/profile",templateUrl:"/views/profile.html",controller:"ProfileCtrl"}).state("item",{url:"/items/{id}",templateUrl:"/views/item.html",controller:"ItemCtrl"}),b.otherwise("login")}]),$(document).ready(function(){$(".sidebar-item").on("click",function(a){var b=$(this).parent().children(".active");b.removeClass("active"),"logout-tab"===a.target.id?$("#market-tab").addClass("active"):$(this).addClass("active")})}),angular.module("thegrandexchange").factory("items",["$http",function(a){return{getAll:function(){return a.get("/api/items")},create:function(b){return a.post("/api/items",b)},get:function(b){return a.get("/api/items/"+b)},getOffers:function(b){return a.get("/api/items/"+b+"/offers")},postOffer:function(b,c){return a.post("/api/items/"+b+"/offers",c)},deleteOffer:function(b,c){return a.delete("/api/items/"+b+"/offers/"+c)},flag:function(b,c){return a.post("/api/items/"+c+"/flags")}}}]),angular.module("thegrandexchange").factory("session",["$cookieStore",function(a){return{name:function(){return a.get("username")},setName:function(b){a.put("username",b)},clear:function(){a.remove("username")}}}]),angular.module("thegrandexchange").factory("users",["$http",function(a){return{create:function(b){return a.post("/api/users",b)},get:function(b){return a.get("/api/users/"+b)},getOffers:function(b){return a.get("/api/users/"+b+"/offers")},getReviews:function(b){return a.get("/api/users/"+b+"/reviews")},getTransactions:function(b){return a.get("/api/users/"+b+"/transactions")},postReview:function(b,c,d){return a.post("/api/users/"+b+"/transactions/"+c,d)}}}]),angular.module("thegrandexchange").controller("CompletedCtrl",["$scope","users","session",function(a,b,c){b.getTransactions(c.name()._id).success(function(b){for(var d=b.transactions,e=[],f=0;f<d.length;f++)d[f].buyOffer.postedBy._id!==c.name()._id||d[f].buyerRated?d[f].sellOffer.postedBy._id!==c.name()._id||d[f].sellerRated||(d[f].isBuyer=!1,e.push(d[f])):(d[f].isBuyer=!0,e.push(d[f]));a.transactions=e}),a.review=function(d){var e=0;e=d.completed?1:-1;var f={text:d.review_content,score:e};console.log(f),b.postReview(c.name()._id,d._id,f).success(function(b){if(b.success)for(var c=0;c<a.transactions.length;c++)if(a.transactions[c]._id===d._id)return void a.transactions.splice(c,1)})}}]),angular.module("thegrandexchange").controller("ItemCtrl",["$http","$scope","$location","$stateParams","session","items","users",function(a,b,c,d,e,f,g){b.order="price";var h=void 0;g.get(e.name()._id).success(function(a){h=a.user.reputation,f.get(d.id).success(function(a){b.item=a.item})}),b.offer=function(a){var c={postedBy:e.name()._id,item:b.item._id,postedAt:Date.now(),price:parseInt(b.price,10),type:a,minReputation:b.reputation};f.postOffer(b.item._id,c).success(function(a){if(b.message=void 0,"No match"===a.message)c.postedBy={firstName:e.name().firstName,lastName:e.name().lastName,reputation:h},b.item.offers.push(c),b.price="",b.reputation="";else if(a.success===!1)b.message=a.message;else for(var d=b.item.offers,f=0;f<d.length;f++)if(d[f].price===a.transaction.price)return void d.splice(f,1)})}}]),angular.module("thegrandexchange").controller("LoginCtrl",["$http","$scope","$location","session",function(a,b,c,d){d.name()&&a.post("/api/sessions",d.name()).success(function(a){a.success===!0?c.path("marketplace"):d.clear()}),b.authenticate=function(){var e={username:b.email,password:b.password};a.post("/api/sessions",e).success(function(a){a.success===!0?(e._id=a.userID,e.firstName=a.firstName,e.lastName=a.lastName,d.setName(e),c.path("marketplace")):b.warning=response.data.message}).error(function(){b.warning="Invalid username and password."}),b.email="",b.password=""}}]),angular.module("thegrandexchange").controller("MainCtrl",["$scope","$location","session","items",function(a,b,c,d){a.isLoggedIn=function(){return void 0!==c.name()},a.logout=function(){c.clear(),b.path("login")},a.flag=function(a){d.flag(c.name()._id,a)},a.toItem=function(a){b.url("items/"+a._id)},a.addItem=function(){console.log("adding item");var b={name:a.name,description:a.description};d.create(b).success(function(b){b.item.bestSell="No offers",b.item.bestBuy="No offers",a.items.push(b.item),a.name="",a.description=""})},d.getAll().success(function(b){if(a.items=b.items,b.success===!0)for(var c=0;c<a.items.length;c++){for(var d=a.items[c],e=d.offers,f=[],g=[],h=0;h<e.length;h++){var i=e[h],j=i.price;"buy"===i.type?f.push(j):"sell"===i.type&&g.push(j)}d.bestBuy=f.length>0?"$"+Math.max.apply(null,f):"No offers",d.bestSell=g.length>0?"$"+Math.min.apply(null,g):"No offers"}else a.items=[{name:"no items found",description:"rekt"}]})}]),angular.module("thegrandexchange").controller("NewUsersCtrl",["$http","$scope","$location","users",function(a,b,c,d){b.addUser=function(){if(b.password!==b.passwordCheck)b.warning="Passwords do not match";else{var a={firstName:b.firstName,lastName:b.lastName,email:b.email,password:b.password};d.create(a).success(function(a){a.success===!0?c.path("sessions"):b.warning=response.data.message}).error(function(a){b.warning=a.data.message})}b.password="",b.passwordCheck=""}}]),angular.module("thegrandexchange").controller("OffersCtrl",["$http","$scope","$filter","$timeout","users","session","items","ngTableParams",function(a,b,c,d,e,f,g,h){b.offers=[],b.deleteOffer=function(a){g.deleteOffer("offer.item._id",a._id).success(function(){for(var c=0;c<b.offers.length;c++)if(b.offers[c]._id===a._id)return b.offers.splice(c,1),void b.tableParams.reload()})},e.getOffers(f.name()._id).success(function(a){b.offers=a.offers,b.tableParams=new h({page:1,count:10,sorting:{name:"asc"}},{total:0,getData:function(a,d){var e=b.offers;d.total(e.length);var f=d.sorting()?c("orderBy")(e,d.orderBy()):e;a.resolve(f.slice((d.page()-1)*d.count(),d.page()*d.count()))}}),b.tableParams.settings().$scope=b})}]),angular.module("thegrandexchange").controller("ProfileCtrl",["$http","$scope","$location","session","users",function(a,b,c,d,e){e.get(d.name()._id).success(function(a){a.success===!0&&(b.user=a.user)})}]);